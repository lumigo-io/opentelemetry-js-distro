name: Tracer Testing
on: [push]
jobs:

  build-package:
    name: Build Lumigo OpenTelemetry for JS distro
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 16
          architecture: x64
      - run: sudo apt-get update && sudo apt-get install build-essential libsdl-pango-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev || true # Node.js 18 does not carry pango
      - run: npm ci
      - run: npm run prettier:ci
      - run: npm run lint
      - run: npm run build
      - name: Upload distro as artifact
        uses: actions/upload-artifact@v3
        with:
          name: distro-package
          path: distro.tgz
          retention-days: 5

  supported-node-versions-testing:
    name: 'Test Node ${{ matrix.node_cimg_tag }} support: ${{ matrix.npm_task }}'
    runs-on: ubuntu-latest
    needs: [build-package]
    strategy:
      matrix:
        node_cimg_tag: [ 14, 16, 18, 20 ]
        npm_task: ['test:unit', 'test:instrumentations']
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node_cimg_tag }}
          architecture: x64
      - run: sudo apt-get update && sudo apt-get install build-essential libsdl-pango-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev || true # Node.js 18 does not carry pango
      - run: npm ci
      # Build it again on this Node.js version: ensuring the Distro remains buildable on the latest supported Node.js
      # will prevent bad surprises when changing the version we use to build the "official" package.
      - run: npm run build
      - run: npm run ${{ matrix.npm_task }}

  unsupported-node-versions-testing:
    name: 'Test Node ${{ matrix.node_cimg_tag }} unsupported'
    runs-on: ubuntu-latest
    needs: [build-package]
    strategy:
      matrix:
        node_cimg_tag: [ 10, 12 ]
    steps:
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node_cimg_tag }}
          architecture: x64
      - name: Download distro
        uses: actions/download-artifact@v3
        with:
          name: distro-package
      - run: npm i ./distro.tgz
      - run: |
          output=$(node -e "require('@lumigo/opentelemetry')" 2>&1)

          if [[ "${output}" != "@lumigo/opentelemetry: Node.js version '$(node --version)' is not supported"* ]]; then
            echo "Unexpected output: ${output}"
            exit 1
          fi

  all-tests:
    runs-on: ubuntu-latest
    needs:
    - supported-node-versions-testing
    - unsupported-node-versions-testing
    steps:
      - run: echo "Hurray!"